import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,a as l,o as p}from"./app-C1x9MSXZ.js";const o={};function e(F,s){return p(),a("div",null,s[0]||(s[0]=[l(`<h1 id="数据库运维技巧" tabindex="-1"><a class="header-anchor" href="#数据库运维技巧"><span>数据库运维技巧</span></a></h1><h2 id="储存情况" tabindex="-1"><a class="header-anchor" href="#储存情况"><span>储存情况</span></a></h2><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="background-color:#272822;color:#F8F8F2;"><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#F92672;">SELECT</span><span style="color:#F92672;"> TOP</span><span style="color:#AE81FF;"> 10</span><span style="color:#F8F8F2;"> </span></span>
<span class="line"><span style="color:#AE81FF;">    t</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">NAME</span><span style="color:#F92672;"> AS</span><span style="color:#E6DB74;"> &quot;表&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#AE81FF;">    s</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">Name</span><span style="color:#F92672;"> AS</span><span style="color:#E6DB74;"> &quot;对象集合&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#AE81FF;">    p</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">rows</span><span style="color:#F92672;"> AS</span><span style="color:#E6DB74;"> &quot;数据行数&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#66D9EF;">    CAST</span><span style="color:#F8F8F2;">(</span><span style="color:#66D9EF;">SUM</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">a</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">total_pages</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">*</span><span style="color:#AE81FF;"> 8</span><span style="color:#F92672;"> /</span><span style="color:#AE81FF;"> 1024</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">00</span><span style="color:#F92672;"> /</span><span style="color:#AE81FF;"> 1024</span><span style="color:#F92672;"> AS</span><span style="color:#66D9EF;font-style:italic;"> NUMERIC</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">36</span><span style="color:#F8F8F2;">, </span><span style="color:#AE81FF;">2</span><span style="color:#F8F8F2;">)) </span><span style="color:#F92672;">AS</span><span style="color:#E6DB74;"> &quot;总内存（GB）&quot;</span><span style="color:#F8F8F2;">, </span></span>
<span class="line"><span style="color:#66D9EF;">    CAST</span><span style="color:#F8F8F2;">(</span><span style="color:#66D9EF;">SUM</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">a</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">used_pages</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">*</span><span style="color:#AE81FF;"> 8</span><span style="color:#F92672;"> /</span><span style="color:#AE81FF;"> 1024</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">00</span><span style="color:#F92672;">/</span><span style="color:#AE81FF;"> 1024</span><span style="color:#F92672;"> AS</span><span style="color:#66D9EF;font-style:italic;"> NUMERIC</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">36</span><span style="color:#F8F8F2;">, </span><span style="color:#AE81FF;">2</span><span style="color:#F8F8F2;">)) </span><span style="color:#F92672;">AS</span><span style="color:#E6DB74;"> &quot;使用内存（GB）&quot;</span><span style="color:#F8F8F2;">, </span></span>
<span class="line"><span style="color:#66D9EF;">    CAST</span><span style="color:#F8F8F2;">((</span><span style="color:#66D9EF;">SUM</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">a</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">total_pages</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">-</span><span style="color:#66D9EF;"> SUM</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">a</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">used_pages</span><span style="color:#F8F8F2;">)) </span><span style="color:#F92672;">*</span><span style="color:#AE81FF;"> 8</span><span style="color:#F92672;"> /</span><span style="color:#AE81FF;"> 1024</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">00</span><span style="color:#F92672;"> /</span><span style="color:#AE81FF;"> 1024</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">00</span><span style="color:#F92672;"> AS</span><span style="color:#66D9EF;font-style:italic;"> NUMERIC</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">36</span><span style="color:#F8F8F2;">, </span><span style="color:#AE81FF;">2</span><span style="color:#F8F8F2;">)) </span><span style="color:#F92672;">AS</span><span style="color:#E6DB74;"> &quot;未使用内存（GB）&quot;</span></span>
<span class="line"><span style="color:#F92672;">FROM</span><span style="color:#F8F8F2;"> </span></span>
<span class="line"><span style="color:#AE81FF;">    sys</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">tables</span><span style="color:#F8F8F2;"> t</span></span>
<span class="line"><span style="color:#F92672;">INNER JOIN</span><span style="color:#F8F8F2;">      </span></span>
<span class="line"><span style="color:#AE81FF;">    sys</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">indexes</span><span style="color:#F8F8F2;"> i </span><span style="color:#F92672;">ON</span><span style="color:#AE81FF;"> t</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">OBJECT_ID</span><span style="color:#F92672;"> =</span><span style="color:#AE81FF;"> i</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">object_id</span></span>
<span class="line"><span style="color:#F92672;">INNER JOIN</span><span style="color:#F8F8F2;"> </span></span>
<span class="line"><span style="color:#AE81FF;">    sys</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">partitions</span><span style="color:#F8F8F2;"> p </span><span style="color:#F92672;">ON</span><span style="color:#AE81FF;"> i</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">object_id</span><span style="color:#F92672;"> =</span><span style="color:#AE81FF;"> p</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">OBJECT_ID</span><span style="color:#F92672;"> AND</span><span style="color:#AE81FF;"> i</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">index_id</span><span style="color:#F92672;"> =</span><span style="color:#AE81FF;"> p</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">index_id</span></span>
<span class="line"><span style="color:#F92672;">INNER JOIN</span><span style="color:#F8F8F2;"> </span></span>
<span class="line"><span style="color:#AE81FF;">    sys</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">allocation_units</span><span style="color:#F8F8F2;"> a </span><span style="color:#F92672;">ON</span><span style="color:#AE81FF;"> p</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">partition_id</span><span style="color:#F92672;"> =</span><span style="color:#AE81FF;"> a</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">container_id</span></span>
<span class="line"><span style="color:#F92672;">LEFT OUTER JOIN</span><span style="color:#F8F8F2;"> </span></span>
<span class="line"><span style="color:#AE81FF;">    sys</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">schemas</span><span style="color:#F8F8F2;"> s </span><span style="color:#F92672;">ON</span><span style="color:#AE81FF;"> t</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">schema_id</span><span style="color:#F92672;"> =</span><span style="color:#AE81FF;"> s</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">schema_id</span></span>
<span class="line"><span style="color:#F92672;">WHERE</span><span style="color:#AE81FF;"> 1</span><span style="color:#F92672;">=</span><span style="color:#AE81FF;">1</span></span>
<span class="line"><span style="color:#88846F;">    --and t.NAME NOT LIKE &#39;dt%&#39; </span></span>
<span class="line"><span style="color:#88846F;">    --AND t.is_ms_shipped = 0</span></span>
<span class="line"><span style="color:#88846F;">    --AND i.OBJECT_ID &gt; 255 </span></span>
<span class="line"><span style="color:#F92672;">GROUP BY</span><span style="color:#F8F8F2;"> </span></span>
<span class="line"><span style="color:#AE81FF;">    t</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">Name</span><span style="color:#F8F8F2;">, </span><span style="color:#AE81FF;">s</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">Name</span><span style="color:#F8F8F2;">, </span><span style="color:#AE81FF;">p</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">Rows</span></span>
<span class="line"><span style="color:#F92672;">ORDER BY</span><span style="color:#F8F8F2;"> </span></span>
<span class="line"><span style="color:#E6DB74;">    &quot;总内存（GB）&quot;</span><span style="color:#F92672;"> DESC</span><span style="color:#F8F8F2;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="锁表处理" tabindex="-1"><a class="header-anchor" href="#锁表处理"><span>锁表处理</span></a></h2><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="background-color:#272822;color:#F8F8F2;"><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#88846F;">-- 查询锁表进程</span></span>
<span class="line"><span style="color:#F92672;">select</span><span style="color:#F8F8F2;"> </span></span>
<span class="line"><span style="color:#F8F8F2;">  request_session_id spid,</span></span>
<span class="line"><span style="color:#66D9EF;">  OBJECT_NAME</span><span style="color:#F8F8F2;">(resource_associated_entity_id) tableName </span></span>
<span class="line"><span style="color:#F92672;">from</span><span style="color:#AE81FF;"> sys</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">dm_tran_locks</span><span style="color:#F92672;"> where</span><span style="color:#F8F8F2;"> resource_type</span><span style="color:#F92672;">=</span><span style="color:#E6DB74;">&#39;OBJECT&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">-- 解锁</span></span>
<span class="line"><span style="color:#F92672;">declare</span><span style="color:#F8F8F2;"> @spid </span><span style="color:#66D9EF;font-style:italic;">int</span><span style="color:#F8F8F2;"> </span></span>
<span class="line"><span style="color:#F92672;">Set</span><span style="color:#F8F8F2;"> @spid </span><span style="color:#F92672;">=</span><span style="color:#AE81FF;"> 107</span><span style="color:#88846F;"> --锁表进程</span></span>
<span class="line"><span style="color:#F92672;">declare</span><span style="color:#F8F8F2;"> @sql </span><span style="color:#66D9EF;font-style:italic;">varchar</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">1000</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F92672;">set</span><span style="color:#F8F8F2;"> @sql</span><span style="color:#F92672;">=</span><span style="color:#E6DB74;">&#39;kill &#39;</span><span style="color:#F92672;">+</span><span style="color:#66D9EF;">cast</span><span style="color:#F8F8F2;">(@spid </span><span style="color:#F92672;">as</span><span style="color:#66D9EF;font-style:italic;"> varchar</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F92672;">exec</span><span style="color:#F8F8F2;">(@sql)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="执行记录" tabindex="-1"><a class="header-anchor" href="#执行记录"><span>执行记录</span></a></h2><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="background-color:#272822;color:#F8F8F2;"><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#F92672;">Select</span><span style="color:#F92672;"> TOP</span><span style="color:#AE81FF;"> 10</span></span>
<span class="line"><span style="color:#AE81FF;">       ST</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">text</span><span style="color:#F92672;"> AS</span><span style="color:#E6DB74;"> &#39;执行的SQL语句&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#AE81FF;">       QS</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">last_execution_time</span><span style="color:#F92672;">  AS</span><span style="color:#E6DB74;"> &#39;最后执行时间&#39;</span><span style="color:#F8F8F2;"> , </span></span>
<span class="line"><span style="color:#AE81FF;">       QS</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">creation_time</span><span style="color:#F92672;"> AS</span><span style="color:#E6DB74;"> &#39;执行时间&#39;</span><span style="color:#F8F8F2;"> , </span></span>
<span class="line"><span style="color:#AE81FF;">       QS</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">execution_count</span><span style="color:#F92672;"> AS</span><span style="color:#E6DB74;"> &#39;执行次数&#39;</span><span style="color:#F8F8F2;">,  </span></span>
<span class="line"><span style="color:#AE81FF;">       QS</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">total_elapsed_time</span><span style="color:#F92672;"> AS</span><span style="color:#E6DB74;"> &#39;耗时&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#AE81FF;">       QS</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">total_logical_reads</span><span style="color:#F92672;"> AS</span><span style="color:#E6DB74;"> &#39;逻辑读取次数&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#AE81FF;">       QS</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">total_logical_writes</span><span style="color:#F92672;"> AS</span><span style="color:#E6DB74;"> &#39;逻辑写入次数&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#AE81FF;">       QS</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">total_physical_reads</span><span style="color:#F92672;"> AS</span><span style="color:#E6DB74;"> &#39;物理读取次数&#39;</span><span style="color:#F8F8F2;">,    </span></span>
<span class="line"><span style="color:#F8F8F2;">       QS.</span><span style="color:#F92672;">*</span></span>
<span class="line"><span style="color:#F92672;">FROM</span><span style="color:#AE81FF;"> sys</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">dm_exec_query_stats</span><span style="color:#F8F8F2;"> QS</span></span>
<span class="line"><span style="color:#F92672;">       CROSS</span><span style="color:#F92672;"> APPLY</span></span>
<span class="line"><span style="color:#AE81FF;">sys</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">dm_exec_sql_text</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">QS</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">sql_handle</span><span style="color:#F8F8F2;">) ST</span></span>
<span class="line"><span style="color:#F92672;">Where</span><span style="color:#AE81FF;"> 1</span><span style="color:#F92672;">=</span><span style="color:#AE81FF;">1</span></span>
<span class="line"><span style="color:#F92672;">  and</span><span style="color:#AE81FF;"> ST</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">text</span><span style="color:#F92672;"> like</span><span style="color:#E6DB74;"> &#39;delete%&#39;</span></span>
<span class="line"><span style="color:#88846F;">  -- and QS.creation_time BETWEEN DATEADD(hh,-1,GETDATE()) AND GETDATE()</span></span>
<span class="line"><span style="color:#F92672;">order by</span><span style="color:#AE81FF;"> QS</span><span style="color:#F8F8F2;">.</span><span style="color:#AE81FF;">last_execution_time</span><span style="color:#F92672;"> desc</span><span style="color:#F8F8F2;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="查看外键约束" tabindex="-1"><a class="header-anchor" href="#查看外键约束"><span>查看外键约束</span></a></h2><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="background-color:#272822;color:#F8F8F2;"><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#88846F;">--在主表中查询主外键关系</span></span>
<span class="line"><span style="color:#F92672;">exec</span><span style="color:#F8F8F2;">  sp_helpconstraint </span><span style="color:#E6DB74;">&#39;tbl_invoice&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="查询区分大小写处理" tabindex="-1"><a class="header-anchor" href="#查询区分大小写处理"><span>查询区分大小写处理</span></a></h2><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="background-color:#272822;color:#F8F8F2;"><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#88846F;">-- （指定某表的某列）,不区分大小写</span></span>
<span class="line"><span style="color:#F92672;">ALTER</span><span style="color:#F92672;"> TABLE</span><span style="color:#F8F8F2;"> tb </span><span style="color:#F92672;">ALTER</span><span style="color:#F8F8F2;"> COLUMN colname </span><span style="color:#F92672;">nvarchar</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">100</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">COLLATE</span><span style="color:#F8F8F2;"> Chinese_PRC_CI_AS;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">-- （指定某表的某列），区分大小写</span></span>
<span class="line"><span style="color:#F92672;">ALTER</span><span style="color:#F92672;"> TABLE</span><span style="color:#F8F8F2;"> tb </span><span style="color:#F92672;">ALTER</span><span style="color:#F8F8F2;"> COLUMN colname </span><span style="color:#F92672;">nvarchar</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">100</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">COLLATE</span><span style="color:#F8F8F2;"> Chinese_PRC_CS_AS;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">-- （指定整个数据库）</span></span>
<span class="line"><span style="color:#F92672;">alter</span><span style="color:#F92672;"> database</span><span style="color:#F8F8F2;"> 数据库 </span><span style="color:#F92672;">COLLATE</span><span style="color:#F8F8F2;"> Chinese_PRC_CS_AS;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,11)]))}const t=n(o,[["render",e]]),i=JSON.parse('{"path":"/databases/sqlserver/maintenance-skills/","title":"数据库运维技巧","lang":"zh-CN","frontmatter":{},"git":{},"readingTime":{"minutes":0.27,"words":81},"filePathRelative":"databases/sqlserver/maintenance-skills/README.md"}');export{t as comp,i as data};
